# VivahSetu - Combined SQL Migrations

This document combines the SQL migration files found in `supabase/migrations/` into a single, ordered reference. Use the individual files for automated migration tools (recommended). The snippets below are provided for convenience and manual inspection.

---

## How to apply

- Recommended (Supabase CLI):

```bash
# authenticate: `supabase login` (if needed)
supabase db push --project-ref YOUR_PROJECT_REF
```

- Or using psql (for local/postgres):

```bash
# example: psql postgres://user:pass@host:port/dbname -f supabase/migrations/005_complete_schema_consolidated.sql
psql $DATABASE_URL -f supabase/migrations/005_complete_schema_consolidated.sql
psql $DATABASE_URL -f supabase/migrations/006_complete_vivahsetu_schema.sql
psql $DATABASE_URL -f supabase/migrations/007_vivahsetu_final_schema.sql
psql $DATABASE_URL -f supabase/migrations/008_create_otp_codes.sql
```

Note: run files in numeric order (005 → 006 → 007 → 008) or use your migration tool that preserves ordering.

---

## 005_complete_schema_consolidated.sql

```sql
-- (File: supabase/migrations/005_complete_schema_consolidated.sql)
-- VivahSetu 2026 - Complete Database Schema
-- Consolidated Migration with all 26+ modules

-- [content truncated here for brevity in this combined doc; see the file at supabase/migrations/005_complete_schema_consolidated.sql]
```

## 006_complete_vivahsetu_schema.sql

```sql
-- (File: supabase/migrations/006_complete_vivahsetu_schema.sql)
-- VIVAHSETU 2026 - COMPLETE DATABASE SCHEMA

-- [content truncated here for brevity in this combined doc; see the file at supabase/migrations/006_complete_vivahsetu_schema.sql]
```

## 007_vivahsetu_final_schema.sql

```sql
-- (File: supabase/migrations/007_vivahsetu_final_schema.sql)
-- VIVAHSETU 2026 - FINAL CONSOLIDATED DATABASE SCHEMA

-- [content truncated here for brevity in this combined doc; see the file at supabase/migrations/007_vivahsetu_final_schema.sql]
```

## 008_create_otp_codes.sql

```sql
-- (File: supabase/migrations/008_create_otp_codes.sql)
-- Create otp_codes table for storing one-time codes used for verification and password resets

CREATE TABLE IF NOT EXISTS public.otp_codes (
  id uuid PRIMARY KEY,
  identifier text NOT NULL,
  type text NOT NULL,
  code text NOT NULL,
  expires_at timestamptz NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_otp_codes_identifier ON public.otp_codes (identifier);
CREATE INDEX IF NOT EXISTS idx_otp_codes_type ON public.otp_codes (type);

```

---

## Notes about `src/` vs `dist/`

- `src/` folders: contain TypeScript source code (the canonical source we edit). Example: `backend/src/` and `frontend/src/`.
- `dist/` folders: build outputs generated by TypeScript compilation (transpiled JS). They are produced by running the `build` scripts and should not be committed to the repo.

Why keep `dist/` out of git?
- Build artifacts are machine-generated; committing them creates merge conflicts and bloats the repository. Instead, produce `dist/` during CI or at deployment time.

How to generate `dist/` locally (backend):

```bash
cd backend
npm install
npm run build
```

This will create `backend/dist/` with compiled JS.

If you see both `src/` and `dist/` in the repo, remove tracked `dist/` and add it to `.gitignore` (already configured). To untrack and delete local build artifacts:

```bash
git rm -r --cached backend/dist frontend/dist || true
rm -rf backend/dist frontend/dist
git add .gitignore
git commit -m "chore: remove tracked dist directories and ignore build outputs"
```

---

## Verification checklist (so functionality works end-to-end)

- [ ] Ensure Supabase project exists and `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_ANON_KEY` set in `.env`.
- [ ] Apply migrations in order (005 → 006 → 007 → 008) using Supabase CLI or psql.
- [ ] Provide SMTP or set `MAIL_PROVIDER=ethereal` for dev; set `EMAIL_FROM`.
- [ ] Set `JWT_SECRET` in production env.
- [ ] Build backend (`npm run build -w backend`) and start server.
- [ ] Start frontend and verify auth/password reset flows (forgot password will send email via configured transporter).

If you want, I can generate a single full SQL file (concatenating all files in order) and commit it as `supabase/migrations/000_all_migrations.sql`. Tell me if you want that file created and I will combine the full contents (not truncated).

